#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}Running pre-commit checks...${NC}"

# Step 1: Format with Prettier
echo "${YELLOW}1. Formatting code with Prettier...${NC}"
pnpm prettier --write . || {
  echo "${RED}✗ Prettier formatting failed${NC}"
  exit 1
}
echo "${GREEN}✓ Prettier formatting passed${NC}"

# Step 2: Lint and fix with ESLint
echo "${YELLOW}2. Linting and fixing with ESLint...${NC}"
pnpm eslint . --fix || {
  echo "${RED}✗ ESLint check failed${NC}"
  exit 1
}
echo "${GREEN}✓ ESLint check passed${NC}"

# Step 3: Type check with TypeScript
echo "${YELLOW}3. Running TypeScript type check...${NC}"
pnpm tsc --noEmit || {
  echo "${RED}✗ TypeScript type check failed${NC}"
  exit 1
}
echo "${GREEN}✓ TypeScript type check passed${NC}"

# Step 4: Run tests
echo "${YELLOW}4. Running tests...${NC}"
pnpm test:run || {
  echo "${RED}✗ Tests failed${NC}"
  exit 1
}
echo "${GREEN}✓ Tests passed${NC}"

# Step 5: Stage lint-staged changes (format + lint fixes)
echo "${YELLOW}5. Running lint-staged on changes...${NC}"
pnpm lint-staged || {
  echo "${RED}✗ lint-staged check failed${NC}"

  exit 1
}
echo "${GREEN}✓ lint-staged check passed${NC}"

echo "${GREEN}All pre-commit checks passed! ✓${NC}"
exit 0
